<!DOCTYPE html>
<html lang="en" data-theme="propeptides">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Propeptides{% endblock %}</title>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <!-- Custom theme variables -->
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: [
                            'Inter',
                            'ui-sans-serif',
                            'system-ui',
                            '-apple-system',
                            'Segoe UI',
                            'Roboto',
                            'Helvetica Neue',
                            'Arial',
                            'Noto Sans',
                            'Apple Color Emoji',
                            'Segoe UI Emoji',
                            'Segoe UI Symbol'
                        ],
                    },
                    colors: {
                        'brand': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        'accent': {
                            50: '#fef3c7',
                            100: '#fde68a',
                            200: '#fcd34d',
                            300: '#fbbf24',
                            400: '#f59e0b',
                            500: '#d97706',
                            600: '#b45309',
                            700: '#92400e',
                            800: '#78350f',
                            900: '#451a03',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="alternate" type="application/rss+xml" title="Propeptides RSS" href="{{ url_for('rss_feed') }}" />
    {% if GA_ID %}
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '{{ GA_ID }}');
    </script>
    {% endif %}
    {% if META_PIXEL_ID %}
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[]; t=b.createElement(e); t.async=!0; t.src=v; s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '{{ META_PIXEL_ID }}'); fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id={{ META_PIXEL_ID }}&ev=PageView&noscript=1"/></noscript>
    {% endif %}

    <!-- Organization JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Propeptides",
      "url": "{{ request.url_root.rstrip('/') }}",
      "logo": "{{ request.url_root.rstrip('/') }}/static/favicon.ico"
    }
    </script>
    {% block head %}{% endblock %}
</head>
<body class="bg-gray-50">
    <!-- Announcement Bar -->
    <div id="announcement-bar" class="bg-brand-600 text-white text-sm">
        <div class="container mx-auto px-4 py-2 flex items-center justify-between">
            <p class="truncate">Free shipping on orders over $99. New customers get 10% off with code WELCOME10.</p>
            <button id="announcement-close" class="ml-4 p-1 rounded hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-white" aria-label="Dismiss announcement">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <nav class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="{{ url_for('index') }}" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                        </div>
                        <span class="text-xl font-bold text-gray-900">Propeptides</span>
                    </a>
                </div>

                <!-- Desktop Navigation -->@@
                <div class="hidden md:flex items-center space-x-8">
                    <a href="{{ url_for('peptides') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint in ['peptides', 'peptide_detail'] else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint in ['peptides', 'peptide_detail'] %}aria-current="page"{% endif %}>Peptides</a>
                    <a href="{{ url_for('posts') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint in ['posts', 'post_detail'] else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint in ['posts', 'post_detail'] %}aria-current="page"{% endif %}>Blog</a>
                    <a href="{{ url_for('community_index') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint in ['community_index', 'community_detail', 'community_new'] else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint in ['community_index', 'community_detail', 'community_new'] %}aria-current="page"{% endif %}>Community</a>
                    <a href="{{ url_for('search') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint == 'search' else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint == 'search' %}aria-current="page"{% endif %}>Search</a>
                    <a href="{{ url_for('assistant') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint == 'assistant' else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint == 'assistant' %}aria-current="page"{% endif %}>Assistant</a>
                    <a href="{{ url_for('calculator') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint == 'calculator' else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint == 'calculator' %}aria-current="page"{% endif %}>Calculator</a>
                    <a href="{{ url_for('tracker') }}" class="font-medium transition-colors {{ 'text-brand-700' if request.endpoint in ['tracker', 'log_dosage', 'add_progress'] else 'text-gray-700 hover:text-brand-600' }}" {% if request.endpoint in ['tracker', 'log_dosage', 'add_progress'] %}aria-current="page"{% endif %}>Tracker</a>
                    <form id="nav-search-form" action="{{ url_for('search') }}" method="get" class="hidden lg:flex items-center space-x-2 ml-2">
                        <div class="relative">
                            <input type="text" name="q" value="{{ request.args.get('q', '') if request.endpoint == 'search' else '' }}" placeholder="Search research..." class="input input-sm input-bordered w-56 xl:w-64 pr-8" aria-label="Search">
                            <button type="submit" class="absolute right-1 top-1.5 text-gray-500 hover:text-brand-600" aria-label="Submit search">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <input type="hidden" name="type" id="nav-search-type" value="{{ request.args.get('type', 'all') if request.endpoint == 'search' else 'all' }}">
                        <div class="join join-horizontal">
                            <button type="button" class="btn btn-xs btn-ghost join-item" data-type="all">All</button>
                            <button type="button" class="btn btn-xs btn-ghost join-item" data-type="product">Peptides</button>
                            <button type="button" class="btn btn-xs btn-ghost join-item" data-type="post">Blog</button>
                            <button type="button" class="btn btn-xs btn-ghost join-item" data-type="community">Community</button>
                        </div>
                    </form>
                </div>

                <!-- Desktop CTA -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="{{ url_for('peptides') }}" class="text-brand-600 hover:text-brand-700 font-medium">Shop</a>
                    <!-- Cart button -->
                    <a id="nav-cart-link" href="{% if current_user.is_authenticated %}{{ url_for('cart') }}{% else %}{{ url_for('login', next=url_for('cart')) }}{% endif %}"
                       class="relative text-gray-700 hover:text-brand-600 transition-colors"
                       aria-label="Cart">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        {% if cart_count and cart_count > 0 %}
                        <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] leading-none font-semibold px-1.5 py-0.5 rounded-full"
                              aria-label="{{ cart_count }} items in cart">{{ cart_count }}</span>
                        {% endif %}
                    </a>
                    {% if current_user.is_authenticated %}
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <button id="profile-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-brand-600 transition-colors" aria-haspopup="true" aria-expanded="false" aria-controls="profile-menu">
                                    <span class="text-sm font-medium">{{ current_user.name }}</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </button>
                                <div id="profile-menu" class="absolute right-0 mt-2 w-52 bg-white rounded-lg shadow-lg border border-gray-200 py-2 hidden" role="menu" aria-labelledby="profile-menu-button">
                                    <a href="{{ url_for('dashboard') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="user" class="w-4 h-4 inline mr-2"></i> Dashboard
                                    </a>
                                    <a href="{{ url_for('orders') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="receipt" class="w-4 h-4 inline mr-2"></i> Orders
                                    </a>
                                    <a href="{{ url_for('payments') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="credit-card" class="w-4 h-4 inline mr-2"></i> Payments
                                    </a>
                                    <a href="{{ url_for('favorites') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="heart" class="w-4 h-4 inline mr-2"></i> Wishlist
                                    </a>
                                    {% if current_user.role == 'admin' %}
                                    <a href="{{ url_for('admin_index') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i> Admin
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('cart') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 inline mr-2"></i> Cart
                                    </a>
                                    <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i> Logout
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="flex items-center space-x-3">
                            <a href="{{ url_for('login', next=url_for('dashboard')) }}" class="text-gray-700 hover:text-brand-600 font-medium">Dashboard</a>
                            <a href="{{ url_for('login', next=request.path) }}" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                                <span>Login</span>
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="mobile-menu-button text-gray-700 hover:text-brand-600 focus:outline-none focus:text-brand-600" onclick="toggleMobileMenu()" aria-controls="mobile-menu" aria-expanded="false" aria-label="Toggle navigation menu">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile menu -->
            <div id="mobile-menu" class="mobile-menu hidden md:hidden py-4 border-t border-gray-200" role="navigation" aria-label="Mobile">
                <div class="flex flex-col space-y-3">
                    <a href="{{ url_for('peptides') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Peptides</a>
                    <a href="{{ url_for('posts') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Blog</a>
                    <a href="{{ url_for('community_index') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Community</a>
                    <a href="{{ url_for('search') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Search</a>
                    <a href="{{ url_for('assistant') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Assistant</a>
                    <a href="{{ url_for('calculator') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Calculator</a>
                    <a href="{{ url_for('tracker') }}" class="text-gray-700 hover:text-brand-600 font-medium transition-colors">Tracker</a>
                    <div class="pt-4 flex flex-col space-y-3">
                        <a href="{{ url_for('peptides') }}" class="text-brand-600 hover:text-brand-700 font-medium">Shop</a>
                        {% if current_user.is_authenticated %}
                            <div class="py-2">
                                <span class="text-sm font-medium text-gray-700">{{ current_user.name }}</span>
                            </div>
                            <a href="{{ url_for('cart') }}" class="text-gray-700 hover:text-brand-700 font-medium flex items-center">
                                <i data-lucide="shopping-cart" class="w-4 h-4 inline mr-2"></i> Cart
                                {% if cart_count and cart_count > 0 %}
                                    <span class="ml-2 inline-flex items-center justify-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-600 text-white">{{ cart_count }}</span>
                                {% endif %}
                            </a>
                            <a href="{{ url_for('dashboard') }}" class="text-brand-600 hover:text-brand-700 font-medium">
                                <i data-lucide="user" class="w-4 h-4 inline mr-2"></i> Dashboard
                            </a>
                            <a href="{{ url_for('orders') }}" class="text-brand-600 hover:text-brand-700 font-medium">
                                <i data-lucide="receipt" class="w-4 h-4 inline mr-2"></i> Orders
                            </a>
                            <a href="{{ url_for('payments') }}" class="text-brand-600 hover:text-brand-700 font-medium">
                                <i data-lucide="credit-card" class="w-4 h-4 inline mr-2"></i> Payments
                            </a>
                            <a href="{{ url_for('favorites') }}" class="text-brand-600 hover:text-brand-700 font-medium">
                                <i data-lucide="heart" class="w-4 h-4 inline mr-2"></i> Wishlist
                            </a>
                            {% if current_user.role == 'admin' %}
                            <a href="{{ url_for('admin_index') }}" class="text-brand-600 hover:text-brand-700 font-medium">
                                <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i> Admin
                            </a>
                            {% endif %}
                            <a href="{{ url_for('logout') }}" class="text-red-600 hover:text-red-700 font-medium">
                                <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i> Logout
                            </a>
                        {% else %}
                            <a href="{{ url_for('login', next=url_for('dashboard')) }}" class="text-gray-700 hover:text-brand-600 font-medium text-center">Dashboard</a>
                            <a href="{{ url_for('login', next=request.path) }}" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-center flex items-center justify-center space-x-2">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                                <span>Login</span>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white">
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Brand & Social -->
                <div>
                    <div class="flex items-center space-x-2">
                        <div class="w-9 h-9 bg-brand-600 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                        </div>
                        <span class="text-lg font-bold">Propeptides</span>
                    </div>
                    <p class="mt-4 text-sm text-gray-400 leading-relaxed">Premium research peptides with rigorous lab verification and researcher-first support.</p>
                    <div class="mt-4 flex space-x-3" aria-label="Social media">
                        <a href="#" class="text-gray-400 hover:text-brand-400 transition-colors" aria-label="Twitter">
                            <i data-lucide="twitter" class="w-4 h-4"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-brand-400 transition-colors" aria-label="YouTube">
                            <i data-lucide="youtube" class="w-4 h-4"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-brand-400 transition-colors" aria-label="Facebook">
                            <i data-lucide="facebook" class="w-4 h-4"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-brand-400 transition-colors" aria-label="Instagram">
                            <i data-lucide="instagram" class="w-4 h-4"></i>
                        </a>
                    </div>
                </div>

                <!-- Shop -->
                <nav aria-label="Footer Shop Links">
                    <h3 class="text-sm font-semibold tracking-wider text-gray-300 uppercase">Shop</h3>
                    <ul class="mt-4 space-y-2 text-sm">
                        <li><a href="{{ url_for('peptides') }}" class="text-gray-400 hover:text-white transition-colors">Peptides</a></li>
                        <li><a href="{{ url_for('calculator') }}" class="text-gray-400 hover:text-white transition-colors">Calculator</a></li>
                        <li><a href="{{ url_for('tracker') }}" class="text-gray-400 hover:text-white transition-colors">Tracker</a></li>
                    </ul>
                </nav>

                <!-- Company -->
                <nav aria-label="Footer Company Links">
                    <h3 class="text-sm font-semibold tracking-wider text-gray-300 uppercase">Company</h3>
                    <ul class="mt-4 space-y-2 text-sm">
                        <li><a href="{{ url_for('posts') }}" class="text-gray-400 hover:text-white transition-colors">Blog</a></li>
                        <li><a href="{{ url_for('privacy') }}" class="text-gray-400 hover:text-white transition-colors">Privacy Policy</a></li>
                        <li><a href="{{ url_for('terms') }}" class="text-gray-400 hover:text-white transition-colors">Terms of Service</a></li>
                        <li><a href="{{ url_for('shipping') }}" class="text-gray-400 hover:text-white transition-colors">Shipping Policy</a></li>
                    </ul>
                </nav>

                <!-- Contact -->
                <div>
                    <h3 class="text-sm font-semibold tracking-wider text-gray-300 uppercase">Subscribe</h3>
                    <form method="POST" action="{{ url_for('newsletter_subscribe') }}" class="mt-4 flex gap-2" data-ajax="newsletter-subscribe">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="email" name="email" required placeholder="Email address" class="flex-1 px-3 py-2 rounded bg-white text-gray-900 placeholder-gray-500">
                        <button type="submit" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 rounded font-medium">Subscribe</button>
                    </form>
                    <p class="mt-2 text-[11px] text-gray-500">By subscribing, you agree to receive research updates. <a href="{{ url_for('privacy') }}" class="underline">Privacy Policy</a>.</p>
                    <h3 class="text-sm font-semibold tracking-wider text-gray-300 uppercase">Contact</h3>
                    <ul class="mt-4 space-y-3 text-sm text-gray-400">
                        <li class="flex items-center space-x-2">
                            <i data-lucide="mail" class="w-4 h-4"></i>
                            <a href="mailto:info@propeptides.com" class="hover:text-white transition-colors">info@propeptides.com</a>
                        </li>
                        <li class="flex items-center space-x-2">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <a href="tel:+18007378433" class="hover:text-white transition-colors">1-800-PEPTIDES</a>
                        </li>
                        <li class="flex items-center space-x-2">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span>Support: 24/7</span>
                        </li>
                    </ul>
                </div>
            </div>


            <div class="border-t border-gray-800 mt-8 pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center text-xs text-gray-400 gap-4">
                    <p class="text-center">&copy; <span id="current-year"></span> Propeptides. All rights reserved.</p>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center space-x-2"><i data-lucide="shield-check" class="w-4 h-4"></i><span>Secure checkout</span></div>
                        <div class="flex items-center space-x-2"><i data-lucide="truck" class="w-4 h-4"></i><span>Fast shipping</span></div>
                        <div class="flex items-center space-x-2"><i data-lucide="badge-check" class="w-4 h-4"></i><span>Quality assured</span></div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const btn = document.querySelector('.mobile-menu-button');
            const isHidden = mobileMenu.classList.toggle('hidden');
            btn.setAttribute('aria-expanded', String(!isHidden));
        }

        // Profile menu toggle with outside click + Escape to close
        (function () {
            const btn = document.getElementById('profile-menu-button');
            const menu = document.getElementById('profile-menu');
            if (btn && menu) {
                function closeMenu() {
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                }
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const willOpen = menu.classList.contains('hidden');
                    menu.classList.toggle('hidden');
                    btn.setAttribute('aria-expanded', String(willOpen));
                });
                document.addEventListener('click', function (e) {
                    if (!menu.classList.contains('hidden')) {
                        const target = e.target;
                        if (!menu.contains(target) && target !== btn && !btn.contains(target)) {
                            closeMenu();
                        }
                    }
                });
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') closeMenu();
                });
            }
        })();

        // Announcement bar dismiss (persisted)
        (function () {
            const bar = document.getElementById('announcement-bar');
            const close = document.getElementById('announcement-close');
            try {
                const dismissed = localStorage.getItem('announcementDismissed');
                if (dismissed === 'true') {
                    bar.style.display = 'none';
                }
                close && close.addEventListener('click', function () {
                    bar.style.display = 'none';
                    localStorage.setItem('announcementDismissed', 'true');
                });
            } catch (e) {
                // If localStorage unavailable, just allow closing without persisting
                close && close.addEventListener('click', function () {
                    bar.style.display = 'none';
                });
            }
        })();

        // Auto-update footer year
        (function () {
            const el = document.getElementById('current-year');
            if (el) el.textContent = String(new Date().getFullYear());
        })();

        // Initialize Lucide icons
        lucide.createIcons();

        // Generic modal/image openers (COA and quality images)
        document.addEventListener('click', function(e){
            const openModalBtn = e.target.closest && e.target.closest('[data-open-modal]');
            if (openModalBtn) {
                const sel = openModalBtn.getAttribute('data-open-modal');
                if (sel) {
                    const dlg = document.querySelector(sel);
                    if (dlg && dlg.showModal) dlg.showModal();
                }
            }
            const openImgBtn = e.target.closest && e.target.closest('[data-open-image]');
            if (openImgBtn) {
                const src = openImgBtn.getAttribute('data-open-image');
                const dlg = document.getElementById('img-modal');
                const img = document.getElementById('img-modal-src');
                if (dlg && img) { img.src = src || ''; if (dlg.showModal) dlg.showModal(); }
            }
        });

        // Sticky ATC visibility on PDP
        (function(){
            const atcForm = document.getElementById('pdp-atc-form');
            const sticky = document.getElementById('sticky-atc');
            if (!atcForm || !sticky || !('IntersectionObserver' in window)) return;
            try {
                const io = new IntersectionObserver((entries) => {
                    entries.forEach((en) => {
                        if (en.isIntersecting) sticky.classList.add('hidden');
                        else sticky.classList.remove('hidden');
                    });
                }, { threshold: 0.05 });
                io.observe(atcForm);
            } catch (err) {}
        })();

        // Nav search type chips (Desktop)
        (function () {
            const form = document.getElementById('nav-search-form');
            if (!form) return;
            const hidden = document.getElementById('nav-search-type');
            const buttons = form.querySelectorAll('button[data-type]');
            function syncActive() {
                buttons.forEach((b) => {
                    if (!hidden) return;
                    if (b.dataset.type === (hidden.value || 'all')) b.classList.add('btn-active');
                    else b.classList.remove('btn-active');
                });
            }
            buttons.forEach((b) => {
                b.addEventListener('click', () => {
                    if (hidden) hidden.value = b.dataset.type || 'all';
                    syncActive();
                    form.submit();
                });
            });
            syncActive();
        })();

        // Quick action buttons on product cards (real wiring)
        document.addEventListener('click', function (e) {
            const target = e.target;
            if (!target) return;
            const btn = target.closest ? target.closest('button[data-action]') : null;
            if (!btn) return;
            const action = btn.dataset.action;
            const card = btn.closest('[data-product-id]') || document;
            if (action === 'wishlist') {
                const wishForm = card.querySelector('form[data-ajax="toggle-favorite"]');
                if (wishForm) {
                    wishForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                } else {
                    showToast('Wishlist not available here', 'error');
                }
            } else if (action === 'compare') {
                const pid = btn.dataset.productId || (card.getAttribute('data-product-id') || '').trim();
                if (!pid) { showToast('Missing product id', 'error'); return; }
                try {
                    const key = 'compare_ids';
                    const arr = JSON.parse(localStorage.getItem(key) || '[]');
                    if (!arr.includes(pid)) arr.push(pid);
                    localStorage.setItem(key, JSON.stringify(arr));
                    showToast(`Added to compare (${arr.length})`);
                } catch (err) { showToast('Compare not available', 'error'); }
            } else if (action === 'quick-add') {
                const addForm = card.querySelector('form[data-ajax="add-to-cart"]');
                if (addForm) {
                    addForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                } else {
                    showToast('Add to cart not available', 'error');
                }
            }
        });

        // Toast helper
        function showToast(message, type = 'success') {
            const root = document.getElementById('toast-root') || (function(){
                const d = document.createElement('div');
                d.id = 'toast-root';
                d.className = 'toast toast-end';
                document.body.appendChild(d);
                return d;
            })();
            const item = document.createElement('div');
            item.className = `alert ${type === 'error' ? 'alert-error' : 'alert-success'} shadow`;
            item.innerHTML = `<span>${message}</span>`;
            root.appendChild(item);
            setTimeout(() => { item.remove(); }, 2500);
        }

        // Update cart count badge in header
        function updateCartCount(n) {
            const link = document.getElementById('nav-cart-link');
            if (!link) return;
            let badge = document.getElementById('cart-count-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.id = 'cart-count-badge';
                badge.className = 'absolute -top-2 -right-2 bg-red-600 text-white text-[10px] leading-none font-semibold px-1.5 py-0.5 rounded-full';
                link.appendChild(badge);
            }
            if (n && Number(n) > 0) {
                badge.textContent = String(n);
                badge.style.display = 'inline-block';
                badge.setAttribute('aria-label', `${n} items in cart`);
            } else {
                badge.style.display = 'none';
            }
        }

        // Intercept Add-to-Cart forms with data-ajax="add-to-cart"
        document.addEventListener('submit', function(e){
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.dataset.ajax === 'add-to-cart') {
                e.preventDefault();
                const formData = new FormData(form);
                fetch(form.action || "{{ url_for('add_to_cart') }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data && data.success) {
                        updateCartCount(data.cart_count);
                        showToast('Added to cart');
                        try { if (window.gtag) gtag('event', 'add_to_cart'); } catch (e) {}
                        try { if (window.fbq) fbq('track', 'AddToCart'); } catch (e) {}
                    } else {
                        showToast('Could not add to cart', 'error');
                    }
                })
                .catch(() => showToast('Error adding to cart', 'error'));
            }
        });

        // Intercept Wishlist toggle forms
        document.addEventListener('submit', function(e){
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.dataset.ajax === 'toggle-favorite') {
                e.preventDefault();
                const formData = new FormData(form);
                fetch(form.action || "{{ url_for('toggle_favorite') }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.success) { showToast('Could not update wishlist', 'error'); return; }
                    // Toggle button state
                    const btn = form.querySelector('button');
                    if (btn) {
                        if (data.favorited) {
                            btn.classList.add('text-red-600');
                            btn.classList.remove('text-gray-400');
                            btn.setAttribute('aria-label', 'Remove from wishlist');
                        } else {
                            btn.classList.remove('text-red-600');
                            btn.classList.add('text-gray-400');
                            btn.setAttribute('aria-label', 'Add to wishlist');
                            // If on favorites page, remove card
                            if (location.pathname.startsWith('/favorites')) {
                                const card = form.closest('.group, .bg-white');
                                if (card) card.remove();
                            }
                        }
                    }
                    try { if (window.gtag) gtag('event', data.favorited ? 'add_to_wishlist' : 'remove_from_wishlist'); } catch (e) {}
                    try { if (window.fbq) fbq('trackCustom', data.favorited ? 'AddToWishlist' : 'RemoveFromWishlist'); } catch (e) {}
                    showToast(data.favorited ? 'Added to wishlist' : 'Removed from wishlist');
                })
                .catch(() => showToast('Error updating wishlist', 'error'));
            }
        });

        // Intercept Stock Alert forms
        document.addEventListener('submit', function(e){
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.dataset.ajax === 'stock-alert') {
                e.preventDefault();
                const formData = new FormData(form);
                fetch(form.action || "{{ url_for('create_stock_alert') }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.success) {
                        showToast(data && data.error ? data.error : 'Could not subscribe', 'error');
                        return;
                    }
                    showToast('We will notify you when back in stock');
                    try { if (window.gtag) gtag('event', 'generate_lead', { method: 'stock_alert' }); } catch (e) {}
                    try { if (window.fbq) fbq('trackCustom', 'StockAlertSubscribe'); } catch (e) {}
                    const btn = form.querySelector('button[type="submit"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = 'Subscribed';
                    }
                })
                .catch(() => showToast('Error subscribing to alert', 'error'));
            }
        });

        // Intercept Newsletter subscribe forms
        document.addEventListener('submit', function(e){
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.dataset.ajax === 'newsletter-subscribe') {
                e.preventDefault();
                const formData = new FormData(form);
                fetch(form.action || "{{ url_for('newsletter_subscribe') }}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.success) {
                        showToast((data && data.error) || 'Subscription failed', 'error');
                        return;
                    }
                    try { if (window.gtag) gtag('event', 'sign_up', { method: 'newsletter' }); } catch (e) {}
                    try { if (window.fbq) fbq('trackCustom', 'NewsletterSubscribe'); } catch (e) {}
                    showToast('Subscribed!');
                    const btn = form.querySelector('button[type="submit"], button');
                    if (btn) { btn.disabled = true; btn.textContent = 'Subscribed'; }
                })
                .catch(() => showToast('Subscription failed', 'error'));
            }
        });
    </script>
</body>
</html>