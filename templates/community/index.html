{% extends "base.html" %}

{% block title %}Community - Propeptides{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-10">
  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Community</h1>
        <p class="text-gray-600 mt-1">Ask questions, share insights, and learn with other researchers.</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="{{ url_for('community_index', sort='new', tag=request.args.get('tag')) }}"
           class="px-3 py-2 rounded-lg text-sm font-medium {{ 'bg-brand-600 text-white' if request.args.get('sort', 'new') == 'new' else 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50' }}">
          Newest
        </a>
        <a href="{{ url_for('community_index', sort='top', tag=request.args.get('tag')) }}"
           class="px-3 py-2 rounded-lg text-sm font-medium {{ 'bg-brand-600 text-white' if request.args.get('sort') == 'top' else 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50' }}">
          Top
        </a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('community_new') }}" class="inline-flex items-center px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-medium transition-colors">
          <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
          New Post
        </a>
        {% else %}
        <a href="{{ url_for('login', next=url_for('community_new')) }}" class="inline-flex items-center px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg font-medium transition-colors">
          <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
          Login to Post
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Tags -->
    <div class="mb-6 flex flex-wrap gap-2">
      <a href="{{ url_for('community_index', sort=request.args.get('sort', 'new')) }}"
         class="px-3 py-1.5 rounded-lg text-sm {{ 'bg-brand-600 text-white' if not active_tag else 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50' }}">All</a>
      {% for tag in tags %}
        <a href="{{ url_for('community_index', tag=tag.slug, sort=request.args.get('sort', 'new')) }}"
           class="px-3 py-1.5 rounded-lg text-sm {{ 'bg-brand-600 text-white' if active_tag and active_tag.slug == tag.slug else 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50' }}">
          #{{ tag.name }}
        </a>
      {% endfor %}
    </div>

    {% if posts.items|length == 0 %}
      <div class="bg-white border border-gray-200 rounded-xl p-10 text-center">
        <div class="mx-auto w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <i data-lucide="message-circle" class="w-6 h-6 text-gray-500"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No posts yet</h3>
        <p class="text-gray-600 mb-4">Be the first to start a conversation.</p>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('community_new') }}" class="inline-flex items-center px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium transition-colors">Create Post</a>
        {% endif %}
      </div>
    {% else %}
      <div class="space-y-4">
        {% for post in posts.items %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 flex">
          <!-- Score & vote -->
          <div class="flex flex-col items-center mr-4">
            <form method="POST" action="{{ url_for('community_vote', slug=post.slug) }}" class="vote-form" data-slug="{{ post.slug }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="value" value="up">
              <button type="submit" class="text-gray-500 hover:text-brand-600" aria-label="Upvote">
                <i data-lucide="arrow-up" class="w-5 h-5"></i>
              </button>
            </form>
            <div class="font-semibold text-gray-900 my-1" data-score="{{ post.slug }}">{{ post.score or 0 }}</div>
            <form method="POST" action="{{ url_for('community_vote', slug=post.slug) }}" class="vote-form" data-slug="{{ post.slug }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="value" value="down">
              <button type="submit" class="text-gray-500 hover:text-red-600" aria-label="Downvote">
                <i data-lucide="arrow-down" class="w-5 h-5"></i>
              </button>
            </form>
          </div>

          <!-- Main -->
          <div class="flex-1">
            <a href="{{ url_for('community_detail', slug=post.slug) }}" class="text-lg font-semibold text-gray-900 hover:text-brand-600">{{ post.title }}</a>
            <div class="mt-1 text-sm text-gray-600">
              <span>by {{ post.user.name }}</span>
              <span class="mx-1">·</span>
              <span>{{ post.created_at.strftime('%b %d, %Y') }}</span>
              <span class="mx-1">·</span>
              <a href="{{ url_for('community_detail', slug=post.slug) }}#comments" class="hover:text-brand-600">{{ post.comment_count or 0 }} comments</a>
            </div>
            {% if post.tags %}
            <div class="mt-2 flex flex-wrap gap-2">
              {% for tag in post.tags %}
              <a href="{{ url_for('community_index', tag=tag.slug, sort=request.args.get('sort', 'new')) }}" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">#{{ tag.name }}</a>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if posts.pages > 1 %}
      <div class="mt-8 flex justify-center">
        <nav class="flex space-x-2">
          {% if posts.has_prev %}
          <a href="{{ url_for('community_index', page=posts.prev_num, tag=request.args.get('tag'), sort=request.args.get('sort')) }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Previous</a>
          {% endif %}
          {% for page_num in posts.iter_pages() %}
            {% if page_num %}
              {% if page_num != posts.page %}
              <a href="{{ url_for('community_index', page=page_num, tag=request.args.get('tag'), sort=request.args.get('sort')) }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">{{ page_num }}</a>
              {% else %}
              <span class="px-4 py-2 bg-brand-600 text-white rounded-lg">{{ page_num }}</span>
              {% endif %}
            {% else %}
            <span class="px-4 py-2">...</span>
            {% endif %}
          {% endfor %}
          {% if posts.has_next %}
          <a href="{{ url_for('community_index', page=posts.next_num, tag=request.args.get('tag'), sort=request.args.get('sort')) }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Next</a>
          {% endif %}
        </nav>
      </div>
      {% endif %}
    {% endif %}
  </div>
</div>

<script>
// Progressive enhancement for voting
for (const form of document.querySelectorAll('.vote-form')) {
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    try {
      const resp = await fetch(this.action, {
        method: 'POST',
        body: new FormData(this),
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      if (data && data.success) {
        const slug = this.dataset.slug;
        const scoreEl = document.querySelector(`[data-score="${slug}"]`);
        if (scoreEl) scoreEl.textContent = data.score;
      } else {
        // Fallback to normal navigation
        this.submit();
      }
    } catch (err) {
      this.submit();
    }
  });
}
</script>
{% endblock %}
