{% extends "base.html" %}

{% block title %}{{ post.title }} - Community - Propeptides{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-10">
  <div class="container mx-auto px-4 max-w-5xl">
    <div class="mb-6">
      <a href="{{ url_for('community_index') }}" class="text-brand-600 hover:text-brand-700 inline-flex items-center text-sm">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back to Community
      </a>
    </div>

    <article class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <header class="mb-4">
        <h1 class="text-3xl font-bold text-gray-900">{{ post.title }}</h1>
        <div class="mt-2 text-sm text-gray-600">
          <span>by {{ post.user.name }}</span>
          <span class="mx-1">·</span>
          <span>{{ post.created_at.strftime('%b %d, %Y') }}</span>
          <span class="mx-1">·</span>
          <span>{{ post.view_count or 0 }} views</span>
        </div>
        {% if post.tags %}
        <div class="mt-2 flex flex-wrap gap-2">
          {% for tag in post.tags %}
          <a href="{{ url_for('community_index', tag=tag.slug) }}" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">#{{ tag.name }}</a>
          {% endfor %}
        </div>
        {% endif %}
      </header>

      <div class="prose max-w-none">
        {{ post.content | markdown }}
      </div>

      <footer class="mt-6 flex items-center gap-4">
        <form method="POST" action="{{ url_for('community_vote', slug=post.slug) }}" class="inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="value" value="up">
          <button type="submit" class="inline-flex items-center px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
            <i data-lucide="arrow-up" class="w-4 h-4 mr-1"></i> Upvote
          </button>
        </form>
        <div class="text-gray-900 font-semibold">Score: {{ post.score or 0 }}</div>
        <form method="POST" action="{{ url_for('community_vote', slug=post.slug) }}" class="inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="value" value="down">
          <button type="submit" class="inline-flex items-center px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
            <i data-lucide="arrow-down" class="w-4 h-4 mr-1"></i> Downvote
          </button>
        </form>
      </footer>
    </article>

    <!-- Comments -->
    <section id="comments" class="mt-10">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Comments ({{ post.comment_count or 0 }})</h2>

      {% if post.comments|length == 0 %}
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center text-gray-600">No comments yet. Be the first to comment.</div>
      {% else %}
        <div class="space-y-4">
          {% for c in (post.comments | sort(attribute='created_at')) %}
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="text-sm text-gray-600 mb-1">{{ c.user.name }} • {{ c.created_at.strftime('%b %d, %Y %H:%M') }}</div>
            <div class="text-gray-900 prose">{{ c.content | markdown }}</div>
          </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Add comment -->
      <div class="mt-6 bg-white rounded-lg border border-gray-200 p-6">
        {% if current_user.is_authenticated %}
        <form method="POST" action="{{ url_for('community_comment', slug=post.slug) }}" class="space-y-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label class="block text-sm font-medium text-gray-700">Add a comment</label>
          <textarea name="content" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 focus:border-brand-500" placeholder="Share your thoughts..." required></textarea>
          <div class="flex justify-end">
            <button type="submit" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg">Comment</button>
          </div>
        </form>
        {% else %}
        <a href="{{ url_for('login', next=request.path) }}" class="inline-flex items-center px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg">
          <i data-lucide="log-in" class="w-4 h-4 mr-2"></i>
          Login to comment
        </a>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<!-- SimpleMDE for comments -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
  (function(){
    const el = document.querySelector('textarea[name="content"]');
    if (el && window.SimpleMDE) {
      new SimpleMDE({ element: el, spellChecker: false, status: false });
    }
  })();
</script>
{% endblock %}
